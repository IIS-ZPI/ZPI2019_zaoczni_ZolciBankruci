# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master
- realease_tag_test

pr:
- develop
- realease_tag_test
name: 1.11$(Rev:.rr)

jobs:
- job: 'A'
  pool:
      vmImage: 'ubuntu-latest'
  steps:
      - task: Maven@3
        inputs:
          mavenPomFile: 'NBP_API/pom.xml'
          mavenOptions: '-Xmx3072m'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          jdkArchitectureOption: 'x64'
          publishJUnitResults: true
          testResultsFiles: '**/surefire-reports/TEST-*.xml'
          goals: 'package'
          checkStyleRunAnalysis: true
          codeCoverageToolOption: 'JaCoCo'
          codeCoverageFailIfEmpty: true
- job: T
  pool:
      vmImage: 'ubuntu-latest'
  dependsOn: A
  condition: succeeded() 
     
  steps:
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.BinariesDirectory)'
      includeRootFolder: true
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
      replaceExistingArchive: true
- job: B
  dependsOn: T
  condition: succeeded() 
  pool: server
  steps:
  - task: InvokeRESTAPI@1
    inputs:
      connectionType: 'connectedServiceName'
      serviceConnection: 'git_rel_aut'
      method: 'POST'
      headers: |
        {
          "Content-Type" : "multipart/form-data" 
        }
      body: |
        {
            "tag_name": "$(Build.BuildNumber)",
            "target_commitish": "develop"
        }
      waitForCompletion: 'false'
    #condition: eq(variables['Build.Reason'], 'IndividualCI')
- job: C
  dependsOn: B
  condition: succeeded() 
  pool: server
  steps:
  - task: InvokeRESTAPI@1
    inputs:
      connectionType: 'connectedServiceName'
      serviceConnection: 'uploadjar'
      method: 'POST'
      headers: |
        {
        "Content-Type":"multipart/form-data", 
        
        }
      body: |
        {
        "name": $(Build.ArtifactStagingDirectory)
        }
      waitForCompletion: 'false'
